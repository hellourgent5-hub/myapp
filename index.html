<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Marketplace</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; padding-bottom: 70px; /* Space for fixed bottom nav */ }
.scroll-container::-webkit-scrollbar { display: none; }
.scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
.category-button {
transition: all 0.2s ease-in-out;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
}
.nav-item {
transition: color 0.2s, transform 0.2s;
}
.nav-item.active {
color: #4f46e5; /* Indigo 600 */
transform: translateY(-2px);
}
/* Custom progress bar styles */
.progress-step { transition: color 0.3s, background-color 0.3s; }
.progress-step.active-step { background-color: #4f46e5; color: white; border-color: #4f46e5; }
.progress-step.completed-step { background-color: #10b981; color: white; border-color: #10b981; }
.progress-line { background-color: #e5e7eb; height: 4px; }
</style>
</head>
<body>

<div id="app" class="max-w-4xl mx-auto p-4 md:p-6">

<!-- Header (Only Cart and Title remain at the top) -->
<header class="flex items-center justify-between mb-6">
<h1 class="text-3xl font-bold text-gray-800 cursor-pointer" onclick="switchView('home')">Swift Mart</h1>
<!-- Cart Button remains at the top -->
<div class="relative">
<button id="cart-button" class="bg-white p-3 rounded-full shadow-lg hover:bg-gray-50 transition relative" disabled>
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l3.294 8.239A.993.993 0 009.62 13h4.764c.241 0 .463-.122.58-.328L19 7m-8 14a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
</svg>
<span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
</button>
</div>
</header>

<!-- Main View (Home) -->
<div id="home-view" class="view">
<!-- Search Bar and Location (Simulated) -->
<div class="mb-6 p-4 bg-white rounded-xl shadow-lg">
<div class="flex items-center space-x-2 text-sm text-gray-600 mb-2">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
<path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
</svg>
<span>76A Eighth Avenue, New York, US</span>
</div>
<input type="text" id="store-search-input" placeholder="Search for stores or items..." class="w-full p-3 border border-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
</div>

<!-- Top Categories -->
<section class="mb-8">
<h2 class="text-lg font-semibold text-gray-700 mb-3">Shop by Service</h2>
<div id="category-buttons" class="flex space-x-4 overflow-x-auto pb-3 scroll-container">
<!-- Categories rendered here -->
</div>
</section>

<!-- Store/Vendor List -->
<section>
<h2 class="text-lg font-semibold text-gray-700 mb-4">All Stores</h2>
<div id="store-list" class="space-y-4">
<!-- Stores will be rendered here -->
</div>
</section>
</div>

<!-- Product View -->
<div id="product-view" class="view hidden">
<button onclick="switchView('home')" class="text-indigo-600 font-semibold mb-4 flex items-center hover:text-indigo-800 transition">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
</svg>
Back to Stores
</button>
<h2 id="store-name" class="text-2xl font-bold text-gray-800 mb-4"></h2>

<!-- Product Search Bar -->
<div class="mb-6">
<input type="text" id="product-search-input" placeholder="Find items in this store..." class="w-full p-3 border border-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
</div>

<div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
<!-- Products will be rendered here -->
</div>
</div>

<!-- Orders View -->
<div id="orders-view" class="view hidden">
<h2 class="text-2xl font-bold text-gray-800 mb-6">My Orders</h2>
<div id="orders-list" class="space-y-6">
<!-- Orders will be rendered here -->
</div>
</div>

<!-- Profile View (For displaying logged in status and controls) -->
<div id="profile-view" class="view hidden">
<h2 class="text-2xl font-bold text-gray-800 mb-6">Account & Profile</h2>
<div id="profile-content" class="bg-white p-6 rounded-xl shadow-lg space-y-4">
<!-- Profile details and controls will be rendered here -->
</div>
</div>

<!-- Cart/Modal Overlay (Hidden by default) -->
<div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
<div class="p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-xl font-bold text-gray-800">Your Cart</h3>
<button id="close-cart-button" class="text-gray-500 hover:text-gray-700">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
</svg>
</button>
</div>

<!-- Cart Items List -->
<div id="cart-items-list" class="max-h-80 overflow-y-auto space-y-3 pr-2">
<!-- Cart items will be rendered here -->
</div>

<!-- Total and Checkout -->
<div class="mt-6 pt-4 border-t border-gray-200">
<div class="flex justify-between items-center mb-4">
<span class="text-lg font-semibold text-gray-700">Total:</span>
<span id="cart-total" class="text-xl font-bold text-indigo-600">â‚¹0.00</span>
</div>
<button id="checkout-button" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition disabled:opacity-50" disabled>
Place Order
</button>
</div>
</div>
</div>
</div>

<!-- Authentication Modal (Sign Up / Log In) -->
<div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300">
<div class="p-6">
<div class="flex justify-between items-center mb-4">
<h3 id="auth-title" class="text-xl font-bold text-gray-800">Log In</h3>
<button id="close-auth-button" class="text-gray-500 hover:text-gray-700">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
</svg>
</button>
</div>

<form id="auth-form">
<input type="email" id="auth-email" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500 transition">
<input type="password" id="auth-password" placeholder="Password" required class="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-indigo-500 focus:border-indigo-500 transition">

<button type="submit" id="auth-submit-button" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition">Log In</button>
</form>

<p class="text-center text-sm mt-4">
<span id="auth-toggle-text">Don't have an account?</span>
<button id="auth-toggle-button" class="text-indigo-600 font-semibold hover:text-indigo-800 transition">Sign Up</button>
</p>
<p id="user-id-display" class="text-xs text-gray-400 mt-2 text-center break-all"></p>
</div>
</div>
</div>

<!-- Message Box (Alerts/Notifications) -->
<div id="message-box" class="fixed bottom-20 right-4 z-50 hidden">
<div id="message-content" class="bg-green-500 text-white px-4 py-3 rounded-lg shadow-xl flex items-center space-x-2">
<!-- Message content here -->
</div>
</div>

</div>

<!-- Fixed Bottom Navigation Bar -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-xl z-40">
<div class="max-w-4xl mx-auto flex justify-around items-center h-16">
<!-- Home -->
<button id="nav-home" onclick="switchView('home')" class="nav-item flex flex-col items-center text-gray-500 hover:text-indigo-600 active">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
</svg>
<span class="text-xs mt-1">Home</span>
</button>

<!-- Orders -->
<button id="nav-orders" onclick="switchView('orders')" class="nav-item flex flex-col items-center text-gray-500 hover:text-indigo-600">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
</svg>
<span class="text-xs mt-1">Orders</span>
</button>

<!-- Profile / Account -->
<button id="nav-profile" onclick="switchView('profile')" class="nav-item flex flex-col items-center text-gray-500 hover:text-indigo-600">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
</svg>
<span class="text-xs mt-1">Profile</span>
</button>
</div>
</nav>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
getAuth,
signInAnonymously,
signInWithCustomToken,
onAuthStateChanged,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
getFirestore,
collection,
addDoc,
doc,
updateDoc, // Needed for status update
query,
setLogLevel,
onSnapshot // Needed for real-time tracking
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// setLogLevel('debug'); // Uncomment to see Firebase logs

// --- Firebase Globals (MANDATORY) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Firebase Initialization ---
let app, db, auth;
let userId = null;
let isAuthReady = false;
let unsubscribeOrders = null; // To store the real-time listener

try {
app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);

// Initial Auth Setup
if (initialAuthToken) {
signInWithCustomToken(auth, initialAuthToken).catch(err => {
console.error("Custom token sign-in failed:", err);
signInAnonymously(auth);
});
} else {
signInAnonymously(auth);
}

// Authentication State Listener: Updates UI and sets userId
onAuthStateChanged(auth, (user) => {
// Clear the previous listener if it exists
if (unsubscribeOrders) {
unsubscribeOrders();
unsubscribeOrders = null;
}

if (user) {
userId = user.uid;
const isRegisteredUser = user.isAnonymous === false;

if (isRegisteredUser) {
document.getElementById('checkout-button').disabled = (Object.keys(cart).length === 0);
// Set up listener for real-time order tracking
setupOrdersListener();
} else {
document.getElementById('checkout-button').disabled = true;
if (currentView !== 'orders' && currentView !== 'profile') showMessage("Signed in anonymously. Please register to place orders.", 'error');
}
} else {
userId = null;
cart = {};
updateCartUI();
document.getElementById('checkout-button').disabled = true;
}
isAuthReady = true;
updateProfileView();
document.getElementById('cart-button').disabled = false;

if (currentView !== 'products') {
switchView('home');
}
});

} catch (e) {
console.error("Firebase initialization failed:", e);
}

// --- Data Simulation & State Management ---
const mockStores = [
{ id: 's1', name: 'Daily Essentials Store', category: 'Grocery', deliveryTime: '20-30 min', deliveryFee: 2.99, rating: 4.3, color: 'bg-green-500' },
{ id: 's2', name: 'Tasty Bites Restaurant', category: 'Food', deliveryTime: '30-40 min', deliveryFee: 3.99, rating: 4.8, color: 'bg-red-500' },
{ id: 's3', name: 'Health First Pharmacy', category: 'Pharmacy', deliveryTime: '25-35 min', deliveryFee: 1.50, rating: 4.5, color: 'bg-blue-500' },
{ id: 's4', name: 'Quick Parcel Service', category: 'Parcel', deliveryTime: '30-60 min', deliveryFee: 5.99, rating: 4.2, color: 'bg-yellow-500' },
{ id: 's5', name: 'Fruit Paradise', category: 'Grocery', deliveryTime: '15-25 min', deliveryFee: 1.99, rating: 4.6, color: 'bg-pink-500' },
{ id: 's6', name: 'Beverage Hub', category: 'Food', deliveryTime: '10-20 min', deliveryFee: 1.49, rating: 4.4, color: 'bg-indigo-500' },
];

const mockProducts = {
's1': [
{ id: 'p1', name: 'Organic Banana', price: 0.99, unit: 'per lb', stock: 50, desc: 'Fresh from the farm.' },
{ id: 'p2', name: 'Whole Wheat Bread', price: 3.50, unit: 'per loaf', stock: 20, desc: 'Baked fresh daily.' },
{ id: 'p3', name: 'Milk (1 Gallon)', price: 4.19, unit: 'gallon', stock: 35, desc: '2% Reduced Fat.' },
{ id: 'p13', name: 'Cereal Box', price: 4.50, unit: 'box', stock: 50, desc: 'Crispy whole grain cereal.' },
{ id: 'p14', name: 'Ground Coffee', price: 8.99, unit: 'bag', stock: 15, desc: 'Medium roast, Arabica beans.' },
{ id: 'p15', name: 'Canned Beans', price: 1.25, unit: 'can', stock: 80, desc: 'Black beans in brine.' },
],
's2': [
{ id: 'p4', name: 'Pepperoni Pizza', price: 12.99, unit: '12"', stock: 40, desc: 'Classic Italian style.' },
{ id: 'p5', name: 'Classic Cheeseburger', price: 8.50, unit: 'each', stock: 60, desc: '100% Beef patty.' },
{ id: 'p6', name: 'Caesar Salad', price: 7.00, unit: 'bowl', stock: 25, desc: 'Fresh Romaine lettuce.' },
{ id: 'p16', name: 'Chicken Wrap', price: 9.50, unit: 'each', stock: 30, desc: 'Grilled chicken and veggies in a tortilla.' },
],
's3': [
{ id: 'p7', name: 'Vitamin C 500mg', price: 15.00, unit: '90 tabs', stock: 100, desc: 'Immune support supplement.' },
{ id: 'p8', name: 'Pain Relief (OTC)', price: 6.99, unit: '24 caps', stock: 50, desc: 'Fast-acting relief.' },
{ id: 'p9', name: 'Hand Sanitizer', price: 3.00, unit: '8 oz', stock: 70, desc: 'Alcohol-based formula.' },
],
's4': [
{ id: 'p10', name: 'Standard Parcel (Local)', price: 5.99, unit: 'delivery', stock: 999, desc: 'Up to 5 lbs, 3 hour delivery window.' },
],
's5': [
{ id: 'p11', name: 'Red Apple (Fuji)', price: 1.20, unit: 'each', stock: 80, desc: 'Crisp and sweet.' },
],
's6': [
{ id: 'p12', name: 'Sparkling Water', price: 1.99, unit: 'bottle', stock: 50, desc: 'Refreshing lemon flavor.' },
]
};

// Cart state stored temporarily in memory
let currentView = 'home';
let currentCategory = 'All';
let currentStoreId = null;
let cart = {};
let isSigningUp = false;
let ordersData = []; // State to hold real-time orders

// --- DOM Elements ---
const $views = {
'home': document.getElementById('home-view'),
'products': document.getElementById('product-view'),
'orders': document.getElementById('orders-view'),
'profile': document.getElementById('profile-view'),
};
const $navItems = {
'home': document.getElementById('nav-home'),
'orders': document.getElementById('nav-orders'),
'profile': document.getElementById('nav-profile'),
};
const $storeList = document.getElementById('store-list');
const $productList = document.getElementById('product-list');
const $ordersList = document.getElementById('orders-list');
const $profileContent = document.getElementById('profile-content');
const $cartModal = document.getElementById('cart-modal');
const $cartCount = document.getElementById('cart-count');
const $cartItemsList = document.getElementById('cart-items-list');
const $cartTotal = document.getElementById('cart-total');
const $checkoutButton = document.getElementById('checkout-button');
const $messageBox = document.getElementById('message-box');
const $messageContent = document.getElementById('message-content');
const $storeSearchInput = document.getElementById('store-search-input');
const $productSearchInput = document.getElementById('product-search-input');
const $authModal = document.getElementById('auth-modal');
const $authTitle = document.getElementById('auth-title');
const $authSubmitButton = document.getElementById('auth-submit-button');
const $authToggleButton = document.getElementById('auth-toggle-button');
const $authToggleText = document.getElementById('auth-toggle-text');
const $authForm = document.getElementById('auth-form');
const $categoryButtonsContainer = document.getElementById('category-buttons');

// --- Real-time Order Listener ---

function setupOrdersListener() {
if (!db || !userId || auth.currentUser.isAnonymous) return;

// Path: /artifacts/{appId}/users/{userId}/orders
const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);

// Clear existing listener if present
if (unsubscribeOrders) {
unsubscribeOrders();
}

// Set up new listener for the user's orders
unsubscribeOrders = onSnapshot(ordersCollectionRef, (snapshot) => {
ordersData = [];
snapshot.forEach(doc => {
ordersData.push({ id: doc.id, ...doc.data() });
});

// Sort by timestamp (most recent first)
ordersData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

// Re-render orders view if it's currently active
if (currentView === 'orders') {
renderOrdersView();
}
}, (error) => {
console.error("Error setting up order listener:", error);
showMessage("Failed to track live orders.", 'error');
});
}

// --- View Management ---

function updateNavBar(activeView) {
Object.values($navItems).forEach(item => item.classList.remove('active', 'text-indigo-600'));
Object.values($navItems).forEach(item => item.classList.add('text-gray-500'));

const activeNavItem = $navItems[activeView];
if (activeNavItem) {
activeNavItem.classList.add('active', 'text-indigo-600');
activeNavItem.classList.remove('text-gray-500');
}
}

function switchView(viewName, storeId = null) {
currentView = viewName;

// Hide all views
Object.values($views).forEach(view => view.classList.add('hidden'));

// Show the requested view
const targetView = $views[viewName];
if (targetView) {
targetView.classList.remove('hidden');
updateNavBar(viewName);

// Perform view-specific rendering
if (viewName === 'home') {
renderStores();
} else if (viewName === 'products' && storeId) {
currentStoreId = storeId;
const store = mockStores.find(s => s.id === storeId);
document.getElementById('store-name').textContent = store ? store.name : 'Store Items';
$productSearchInput.value = '';
renderProducts(storeId);
} else if (viewName === 'orders') {
renderOrdersView(); // This will use the live ordersData state
} else if (viewName === 'profile') {
updateProfileView();
}
}
}

// --- Utility Functions ---

function showMessage(message, type = 'success') {
$messageContent.textContent = message;
$messageContent.className = type === 'success' ? 'bg-green-500 text-white px-4 py-3 rounded-lg shadow-xl flex items-center space-x-2' : 'bg-red-500 text-white px-4 py-3 rounded-lg shadow-xl flex items-center space-x-2';
$messageBox.classList.remove('hidden');
setTimeout(() => {
$messageBox.classList.add('hidden');
}, 3000);
}

// --- Auth & Profile Functions ---

function updateProfileView() {
const user = auth.currentUser;
$profileContent.innerHTML = '';

if (isAuthReady && user) {
if (user.isAnonymous) {
$profileContent.innerHTML = `
<p class="text-lg font-bold text-gray-800">Welcome, Anonymous User!</p>
<p class="text-sm text-gray-600">You are currently signed in anonymously. Please register to save your data and place orders.</p>
<button onclick="openAuthModal('signup')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition">Register Now</button>
<p class="text-xs text-gray-400 mt-2 break-all">Temporary ID: ${userId}</p>
`;
} else {
$profileContent.innerHTML = `
<div class="flex items-center space-x-4">
<div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-xl font-bold">
${user.email.charAt(0).toUpperCase()}
</div>
<div>
<p class="text-xl font-bold text-gray-800">Hello, Customer!</p>
<p class="text-sm text-gray-600 truncate">${user.email}</p>
</div>
</div>
<div class="space-y-2 pt-4">
<button onclick="switchView('orders')" class="w-full text-left px-4 py-3 bg-gray-50 rounded-lg text-gray-700 font-medium hover:bg-gray-100 transition flex items-center justify-between">
My Orders History
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
<path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
</svg>
</button>
</div>
<button onclick="handleLogout()" class="w-full mt-4 text-red-600 py-3 rounded-lg font-bold hover:bg-red-50 transition border border-red-300">Logout</button>
<p class="text-xs text-gray-400 mt-2 break-all text-center">User ID: ${userId}</p>
`;
}
} else {
$profileContent.innerHTML = `
<p class="text-lg font-bold text-gray-800">You are not signed in.</p>
<p class="text-sm text-gray-600">Log in or create an account to start ordering and track your history.</p>
<button onclick="openAuthModal('login')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition">Log In / Sign Up</button>
`;
}
}

function openAuthModal(mode = 'login') {
isSigningUp = (mode === 'signup');
renderAuthModal();
document.getElementById('auth-email').value = '';
document.getElementById('auth-password').value = '';
$authModal.classList.remove('hidden');
}

function renderAuthModal() {
if (isSigningUp) {
$authTitle.textContent = 'Sign Up';
$authSubmitButton.textContent = 'Create Account';
$authToggleText.textContent = 'Already have an account?';
$authToggleButton.textContent = 'Log In';
} else {
$authTitle.textContent = 'Log In';
$authSubmitButton.textContent = 'Log In';
$authToggleText.textContent = "Don't have an account?";
$authToggleButton.textContent = 'Sign Up';
}
}

async function handleAuth(event) {
event.preventDefault();
$authSubmitButton.disabled = true;

const email = document.getElementById('auth-email').value;
const password = document.getElementById('auth-password').value;

try {
if (isSigningUp) {
await createUserWithEmailAndPassword(auth, email, password);
showMessage('Sign up successful! You are now logged in.', 'success');
} else {
await signInWithEmailAndPassword(auth, email, password);
showMessage('Login successful!', 'success');
}
$authModal.classList.add('hidden');
switchView('profile');

} catch (error) {
let errorMessage = 'An authentication error occurred.';
if (error.code === 'auth/email-already-in-use') {
errorMessage = 'This email is already registered. Please log in.';
} else if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
errorMessage = 'Invalid email or password.';
} else if (error.code === 'auth/weak-password') {
errorMessage = 'Password should be at least 6 characters.';
}
showMessage(errorMessage, 'error');
console.error("Auth Error:", error.code, error.message);
} finally {
$authSubmitButton.disabled = false;
}
}

async function handleLogout() {
try {
await signOut(auth);
showMessage('You have been logged out.', 'success');
switchView('home');
} catch (error) {
showMessage('Logout failed.', 'error');
console.error("Logout Error:", error);
}
}

// --- Store and Product Functions (Unchanged) ---

function renderCategories() {
$categoryButtonsContainer.innerHTML = '';
const categories = ['All', 'Grocery', 'Food', 'Pharmacy', 'Parcel'];

categories.forEach(category => {
const button = document.createElement('button');
button.className = `category-button flex-shrink-0 bg-white px-5 py-3 rounded-xl text-sm text-gray-700 font-medium hover:bg-indigo-50 transition`;
if (category === currentCategory) {
button.classList.add('bg-indigo-100', 'text-indigo-700', 'active-category');
}
button.textContent = category;
button.setAttribute('data-category', category);
button.onclick = () => {
document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'active-category'));
button.classList.add('bg-indigo-100', 'text-indigo-700', 'active-category');

currentCategory = category;
renderStores();
};
$categoryButtonsContainer.appendChild(button);
});
}

function renderStores() {
$storeList.innerHTML = '';
const filter = $storeSearchInput.value.toLowerCase();

const filteredStores = mockStores.filter(store =>
(currentCategory === 'All' || store.category === currentCategory) &&
(store.name.toLowerCase().includes(filter) || store.category.toLowerCase().includes(filter))
);

if (filteredStores.length === 0) {
$storeList.innerHTML = `<p class="text-gray-500 p-4 bg-white rounded-xl shadow-md">No stores found matching "${filter}" in the selected category.</p>`;
return;
}

filteredStores.forEach(store => {
const storeEl = document.createElement('div');
storeEl.className = 'bg-white rounded-xl shadow-md p-4 flex items-center justify-between transition hover:shadow-lg cursor-pointer';
storeEl.setAttribute('data-store-id', store.id);
storeEl.innerHTML = `
<div class="flex items-center space-x-4">
<div class="w-12 h-12 ${store.color} rounded-full flex items-center justify-center text-white text-lg font-bold">
${store.category[0]}
</div>
<div>
<p class="text-lg font-semibold text-gray-800">${store.name}</p>
<p class="text-sm text-gray-500">${store.deliveryTime} | <span class="font-medium">â‚¹${store.deliveryFee.toFixed(2)} delivery</span></p>
</div>
</div>
<div class="flex flex-col items-end">
<div class="flex items-center space-x-1 text-sm text-yellow-500">
<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.05a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.05a1 1 0 00-1.175 0l-2.817 2.05c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
</svg>
<span class="font-bold">${store.rating.toFixed(1)}</span>
</div>
<button onclick="switchView('products', '${store.id}')" class="mt-2 text-sm text-indigo-600 font-medium hover:text-indigo-800">View Items</button>
</div>
`;
storeEl.onclick = () => switchView('products', store.id);
$storeList.appendChild(storeEl);
});
}

function renderProducts(storeId) {
$productList.innerHTML = '';
const allProducts = mockProducts[storeId] || [];
const filter = $productSearchInput.value.toLowerCase();

const filteredProducts = allProducts.filter(product =>
product.name.toLowerCase().includes(filter) || product.desc.toLowerCase().includes(filter)
);

if (filteredProducts.length === 0) {
$productList.innerHTML = `<p class="text-gray-500 p-4 col-span-full bg-white rounded-xl shadow-md">No items found matching "${filter}".</p>`;
return;
}

filteredProducts.forEach(product => {
const cartItem = cart[product.id];
const quantity = cartItem ? cartItem.quantity : 0;

const productEl = document.createElement('div');
productEl.className = 'bg-white p-4 rounded-xl shadow-md border border-gray-100 flex flex-col justify-between';
productEl.innerHTML = `
<div>
<p class="text-xl font-semibold text-gray-800 mb-1">${product.name}</p>
<p class="text-sm text-gray-500 mb-3">${product.desc}</p>
</div>
<div>
<p class="text-lg font-bold text-indigo-600 mb-3">â‚¹${product.price.toFixed(2)} <span class="text-sm font-normal text-gray-500">/${product.unit}</span></p>

<div id="controls-${product.id}" class="flex justify-between items-center space-x-2">
${quantity === 0
? `<button onclick="addToCart('${product.id}', '${storeId}')" class="flex-1 bg-indigo-500 text-white py-2 rounded-lg font-medium hover:bg-indigo-600 transition">Add to Cart</button>`
: `
<button onclick="updateCartQuantity('${product.id}', -1)" class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition w-10 h-10 flex items-center justify-center font-bold text-lg">-</button>
<span class="text-lg font-bold w-10 text-center">${quantity}</span>
<button onclick="updateCartQuantity('${product.id}', 1)" class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition w-10 h-10 flex items-center justify-center font-bold text-lg">+</button>
`
}
</div>
</div>
`;
$productList.appendChild(productEl);
});
}

function addToCart(productId, storeId) {
const user = auth.currentUser;
if (!user) {
showMessage("Please log in or sign up to add items to the cart.", 'error');
openAuthModal('login');
return;
}

const storeProducts = mockProducts[storeId];
const product = storeProducts.find(p => p.id === productId);

if (!product) return;

if (Object.keys(cart).length > 0) {
const firstItemStoreId = cart[Object.keys(cart)[0]].storeId;
if (firstItemStoreId !== storeId) {
showMessage("You can only order from one store at a time. Please empty your cart first.", 'error');
return;
}
}

if (cart[productId]) {
cart[productId].quantity += 1;
} else {
cart[productId] = { item: product, quantity: 1, storeId };
}

showMessage(`${product.name} added to cart!`);
updateCartUI();
if (currentView === 'products') renderProducts(currentStoreId);
}

function updateCartQuantity(productId, delta) {
if (!cart[productId]) return;

cart[productId].quantity += delta;

if (cart[productId].quantity <= 0) {
delete cart[productId];
if (Object.keys(cart).length === 0 && !$cartModal.classList.contains('hidden')) {
$cartModal.classList.add('hidden');
}
}

updateCartUI();
if (currentView === 'products' && currentStoreId) renderProducts(currentStoreId);
}

function updateCartUI() {
let totalItems = 0;
let totalPrice = 0;
let deliveryFee = 0;
$cartItemsList.innerHTML = '';

const user = auth.currentUser;
const isRegisteredUser = user && user.isAnonymous === false;

const items = Object.values(cart);

if (items.length > 0) {
const storeId = items[0].storeId;
const store = mockStores.find(s => s.id === storeId);
deliveryFee = store ? store.deliveryFee : 0;

items.forEach(itemData => {
const itemTotal = itemData.item.price * itemData.quantity;
totalPrice += itemTotal;
totalItems += itemData.quantity;

const itemEl = document.createElement('div');
itemEl.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
itemEl.innerHTML = `
<div class="flex-1">
<p class="font-medium text-gray-800">${itemData.item.name}</p>
<p class="text-sm text-gray-500">â‚¹${itemData.item.price.toFixed(2)} x ${itemData.quantity}</p>
</div>
<div class="flex items-center space-x-2">
<button onclick="updateCartQuantity('${itemData.item.id}', -1)" class="text-indigo-600 hover:text-indigo-800 font-bold">-</button>
<span class="w-6 text-center text-gray-800">${itemData.quantity}</span>
<button onclick="updateCartQuantity('${itemData.item.id}', 1)" class="text-indigo-600 hover:text-indigo-800 font-bold">+</button>
</div>
`;
$cartItemsList.appendChild(itemEl);
});

const feeEl = document.createElement('div');
feeEl.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border-t border-gray-200 mt-2';
feeEl.innerHTML = `
<p class="font-medium text-gray-800">Delivery Fee</p>
<p class="text-sm text-gray-500">â‚¹${deliveryFee.toFixed(2)}</p>
`;
$cartItemsList.appendChild(feeEl);

totalPrice += deliveryFee;

} else {
$cartItemsList.innerHTML = '<p class="text-center text-gray-500 py-8">Your cart is empty. Start shopping!</p>';
}

$cartCount.textContent = totalItems;
$cartTotal.textContent = `â‚¹${totalPrice.toFixed(2)}`;


// Disable checkout if cart is empty OR if user is not a registered user
if (totalItems === 0) {
$checkoutButton.textContent = 'Place Order';
$checkoutButton.disabled = true;
} else if (!isRegisteredUser) {
$checkoutButton.textContent = 'Register to Checkout';
$checkoutButton.disabled = true;
$checkoutButton.onclick = () => { $cartModal.classList.add('hidden'); openAuthModal('signup'); };
} else {
$checkoutButton.textContent = 'Place Order';
$checkoutButton.disabled = false;
$checkoutButton.onclick = placeOrder;
}
}

async function placeOrder() {
const user = auth.currentUser;
if (!user || user.isAnonymous) {
showMessage("Please register an account to place a final order.", 'error');
$cartModal.classList.add('hidden');
openAuthModal('login');
return;
}

if (Object.keys(cart).length === 0) {
showMessage('Your cart is empty!', 'error');
return;
}

$checkoutButton.textContent = 'Processing...';
$checkoutButton.disabled = true;

try {
const items = Object.values(cart).map(item => ({
productId: item.item.id,
name: item.item.name,
price: item.item.price,
quantity: item.quantity
}));

const store = mockStores.find(s => s.id === items[0].storeId);
const deliveryFee = store ? store.deliveryFee : 0;
const totalAmount = parseFloat($cartTotal.textContent.replace('â‚¹', ''));

// Create the order object
const order = {
userId: user.uid,
storeId: store.id,
storeName: store.name,
items: items,
totalAmount: totalAmount,
deliveryFee: deliveryFee,
timestamp: new Date().toISOString(),
status: 'Placed', // Initial status
eta: new Date(Date.now() + 40 * 60000).toISOString() // Simulated 40 min ETA
};

// Save the order to Firestore
const ordersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/orders`);
const newOrderRef = await addDoc(ordersCollectionRef, order);
const newOrderId = newOrderRef.id;


// --- Start Simulation ---
simulateDeliveryStatus(newOrderId, 10000); // Start tracking status updates after 10 seconds

// Clear the cart and reset state
cart = {};
currentStoreId = null;

// Close the modal, update UI, and show success message
$cartModal.classList.add('hidden');
updateCartUI();

// Switch to the orders view to see tracking in action
switchView('orders');

showMessage(`Order #${newOrderId.substring(0, 8)} successfully placed!`, 'success');

} catch (e) {
showMessage("Order placement failed. Please try again.", 'error');
console.error("Firestore Order Error:", e);
} finally {
$checkoutButton.textContent = 'Place Order';
updateCartUI();
}
}

// --- NEW: Live Tracking Simulation ---

const statusSequence = [
{ status: 'Preparing', delay: 10000 }, // 10 seconds
{ status: 'Out for Delivery', delay: 15000 }, // 15 seconds after preparing (25 total)
{ status: 'Delivered', delay: 10000 } // 10 seconds after delivery (35 total)
];

async function updateOrderStatus(orderId, newStatus) {
try {
const orderDocRef = doc(db, `artifacts/${appId}/users/${userId}/orders`, orderId);
await updateDoc(orderDocRef, {
status: newStatus
});
} catch (error) {
console.error(`Failed to update status for order ${orderId} to ${newStatus}:`, error);
}
}

function simulateDeliveryStatus(orderId, initialDelay) {
// Use setTimeout to simulate the time passing between status changes
statusSequence.forEach((step, index) => {
let cumulativeDelay = initialDelay;
if (index > 0) {
// Calculate total cumulative delay
for (let i = 0; i <= index; i++) {
cumulativeDelay += statusSequence[i].delay;
}
}

setTimeout(() => {
updateOrderStatus(orderId, step.status);
if (step.status === 'Delivered') {
showMessage(`Order #${orderId.substring(0, 8)} has been Delivered!`, 'success');
}
}, cumulativeDelay);
});
}

// --- Orders View Functions ---

// Helper function to render the progress bar
function renderProgressBar(currentStatus) {
const steps = ['Placed', 'Preparing', 'Out for Delivery', 'Delivered'];
let html = '<div class="flex justify-between items-start mb-4 relative">';

// Progress Line
const statusIndex = steps.indexOf(currentStatus);
const progress = (statusIndex / (steps.length - 1)) * 100;

html += `<div class="absolute top-2 left-0 right-0 h-1 bg-gray-200 z-0 mx-8">
<div class="h-full bg-indigo-500 transition-all duration-500 ease-in-out rounded" style="width: ${progress}%;"></div>
</div>`;

steps.forEach((step, index) => {
let stepClass = 'progress-step p-2 border-2 border-gray-300 rounded-full text-xs font-bold text-gray-500 w-8 h-8 flex items-center justify-center relative z-10';
let labelClass = 'absolute top-9 text-xs text-center font-medium w-max -ml-4';

if (statusIndex >= index) {
stepClass = 'progress-step completed-step border-green-500 bg-green-500 text-white w-8 h-8 flex items-center justify-center relative z-10 rounded-full font-bold text-xs';
}
if (statusIndex === index) {
stepClass = 'progress-step active-step border-indigo-500 bg-indigo-500 text-white w-10 h-10 flex items-center justify-center relative z-10 rounded-full font-bold text-base shadow-lg';
labelClass += ' text-indigo-600';
}

// Adjust label position for 'Out for Delivery' to prevent overlap
const labelAdjustment = step === 'Out for Delivery' ? 'right: -30px; left: auto;' : 'left: 50%; transform: translateX(-50%);';


html += `
<div class="flex flex-col items-center flex-1">
<div class="${stepClass}">
${index + 1}
</div>
<span class="mt-4 text-xs font-semibold ${statusIndex === index ? 'text-indigo-600' : 'text-gray-500'}">${step}</span>
</div>
`;
});

html += '</div>';
return html;
}

function renderOrdersView() {
$ordersList.innerHTML = '<p class="text-center text-gray-500">Loading orders...</p>';

if (!auth.currentUser || auth.currentUser.isAnonymous) {
$ordersList.innerHTML = '<div class="bg-yellow-100 border border-yellow-400 text-yellow-700 p-4 rounded-lg">You must be logged in with a registered account to view and track past orders.</div>';
return;
}

// ordersData is populated by the onSnapshot listener
const orders = ordersData;
$ordersList.innerHTML = '';

if (orders.length === 0) {
$ordersList.innerHTML = '<p class="text-center text-gray-500 py-12">You haven\'t placed any orders yet.</p>';
return;
}

orders.forEach(order => {
const orderDate = new Date(order.timestamp).toLocaleString();

const itemsList = order.items.map(item => `
<li class="flex justify-between text-sm text-gray-600">
<span>${item.name} x ${item.quantity}</span>
<span>â‚¹${(item.price * item.quantity).toFixed(2)}</span>
</li>
`).join('');

const statusColor = order.status === 'Delivered' ? 'bg-green-500' :
order.status === 'Cancelled' ? 'bg-red-500' :
'bg-indigo-500';

const trackingStatus = renderProgressBar(order.status);

const orderEl = document.createElement('div');
orderEl.className = 'bg-white rounded-xl shadow-lg p-5 border-t-4 border-indigo-500';
orderEl.innerHTML = `
<div class="flex justify-between items-center mb-4 border-b pb-3">
<p class="text-lg font-bold text-gray-800">Order ID: <span class="text-sm font-normal text-gray-500">#${order.id.substring(0, 8)}</span></p>
<span class="px-3 py-1 text-sm font-semibold rounded-full text-white ${statusColor}">${order.status}</span>
</div>

<!-- Live Tracking Progress Bar -->
<div class="mb-6">
${trackingStatus}
</div>

<p class="text-sm text-gray-600 mb-4">
<span class="font-medium">Store:</span> ${order.storeName}
<span class="mx-2 text-gray-400">|</span>
<span class="font-medium">Ordered:</span> ${orderDate}
${order.eta ? `<span class="mx-2 text-gray-400">|</span> <span class="font-medium">Est. Arrival:</span> ${new Date(order.eta).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : ''}
</p>

<h4 class="font-semibold text-gray-700 mb-2">Items:</h4>
<ul class="space-y-1 pl-1 mb-4 border-b pb-4">
${itemsList}
<li class="flex justify-between text-sm text-gray-600 border-t mt-2 pt-2">
<span>Delivery Fee</span>
<span>â‚¹${order.deliveryFee.toFixed(2)}</span>
</li>
</ul>

<div class="flex justify-between items-center">
<span class="text-xl font-bold text-gray-800">Total:</span>
<span class="text-2xl font-extrabold text-indigo-600">â‚¹${order.totalAmount.toFixed(2)}</span>
</div>
`;
$ordersList.appendChild(orderEl);
});
}


// --- Event Listeners and Initialization ---

// Expose functions to the global scope for inline HTML calls
window.switchView = switchView;
window.addToCart = addToCart;
window.updateCartQuantity = updateCartQuantity;
window.openAuthModal = openAuthModal;
window.handleLogout = handleLogout;

// Store Search Filter (Home View)
$storeSearchInput.addEventListener('input', () => {
if (currentView === 'home') renderStores();
});

// Product Search Filter (Product View)
$productSearchInput.addEventListener('input', () => {
if (currentView === 'products' && currentStoreId) renderProducts(currentStoreId);
});


// Cart Modal Controls
document.getElementById('cart-button').addEventListener('click', () => {
if (Object.keys(cart).length === 0) {
showMessage("Your cart is empty!", 'error');
return;
}
updateCartUI();
$cartModal.classList.remove('hidden');
});

document.getElementById('close-cart-button').addEventListener('click', () => {
$cartModal.classList.add('hidden');
});

// Auth Modal Controls
document.getElementById('close-auth-button').addEventListener('click', () => {
$authModal.classList.add('hidden');
if (currentView === 'profile') updateProfileView();
});

$authToggleButton.addEventListener('click', () => {
isSigningUp = !isSigningUp;
renderAuthModal();
});

// Attach auth form handler
$authForm.addEventListener('submit', handleAuth);

// Initial rendering on load
renderCategories();

</script>
</body>
</html>
